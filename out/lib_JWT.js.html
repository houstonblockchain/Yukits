

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      lib/JWT.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      African Menu
    </h3>

    <h3>Classes</h3><ul><li id="Credentials-nav"><a href="global.html#Credentials">Credentials</a><ul class='methods'><li data-type="method" id="Credentials-attest-nav"><a href="global.html#Credentials#attest">attest</a></li><li data-type="method" id="Credentials-createRequest-nav"><a href="global.html#Credentials#createRequest">createRequest</a></li><li data-type="method" id="Credentials-lookup-nav"><a href="global.html#Credentials#lookup">lookup</a></li><li data-type="method" id="Credentials-push-nav"><a href="global.html#Credentials#push">push</a></li><li data-type="method" id="Credentials-receive-nav"><a href="global.html#Credentials#receive">receive</a></li></ul></li></ul><h3>Modules</h3><ul><li id="uport-js_JWT-nav"><a href="module-uport-js_JWT.html">uport-js/JWT</a><ul class='methods'><li data-type="method" id="uport-js_JWT-createJWT-nav"><a href="module-uport-js_JWT.html#.createJWT">createJWT</a></li><li data-type="method" id="uport-js_JWT-verifyJWT-nav"><a href="module-uport-js_JWT.html#.verifyJWT">verifyJWT</a></li><li data-type="method" id="uport-js_JWT-check if string is hex string of specific length-nav"><a href="module-uport-js_JWT.html#~checkifstringishexstringofspecificlength">check if string is hex string of specific length</a></li><li data-type="method" id="uport-js_JWT-createJWT-nav"><a href="module-uport-js_JWT.html#~createJWT">createJWT</a></li><li data-type="method" id="uport-js_JWT-fromAscii-nav"><a href="module-uport-js_JWT.html#~fromAscii">fromAscii</a></li><li data-type="method" id="uport-js_JWT-fromUtf8-nav"><a href="module-uport-js_JWT.html#~fromUtf8">fromUtf8</a></li><li data-type="method" id="uport-js_JWT-getKeys get specific key from inner object array of objects-nav"><a href="module-uport-js_JWT.html#~getKeysgetspecifickeyfrominnerobjectarrayofobjects">getKeys get specific key from inner object array of objects</a></li><li data-type="method" id="uport-js_JWT-toAscii-nav"><a href="module-uport-js_JWT.html#~toAscii">toAscii</a></li><li data-type="method" id="uport-js_JWT-toUtf8-nav"><a href="module-uport-js_JWT.html#~toUtf8">toUtf8</a></li><li data-type="method" id="uport-js_JWT-verifyJWT-nav"><a href="module-uport-js_JWT.html#~verifyJWT">verifyJWT</a></li></ul></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#encryptMessage">encryptMessage</a></li><li><a href="global.html#padMessage">padMessage</a></li><li><a href="global.html#SimpleSigner">SimpleSigner</a></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        lib/JWT.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.IAT_SKEW = undefined;

var _extends = Object.assign || function (target) { for (var i = 1; i &lt; arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.createJWT = createJWT;
exports.verifyJWT = verifyJWT;

var _jsontokens = require('jsontokens');

var _mnid = require('mnid');

var _base64url = require('base64url');

var _base64url2 = _interopRequireDefault(_base64url);

function _interopRequireDefault(obj) { return obj &amp;&amp; obj.__esModule ? obj : { default: obj }; }

var JOSE_HEADER = { typ: 'JWT', alg: 'ES256K' };

function encodeSection(data) {
  return _base64url2.default.encode(JSON.stringify(data));
}

var ENCODED_HEADER = encodeSection(JOSE_HEADER);

var LEGACY_MS = 1000000000000;

var IAT_SKEW = exports.IAT_SKEW = 60;

/**  @module uport-js/JWT */

/**
*  Creates a signed JWT given an address which becomes the issuer, a signer, and a payload for which the signature is over.
*
*  @example
*  const signer = SimpleSigner(process.env.PRIVATE_KEY)
*  createJWT({address: '5A8bRWU3F7j3REx3vkJ...', signer}, {key1: 'value', key2: ..., ... }).then(jwt => {
*      ...
*  })
*
*  @param    {Object}            [config]           an unsigned credential object
*  @param    {String}            config.address     address, typically the uPort address of the signer which becomes the issuer
*  @param    {SimpleSigner}      config.signer      a signer, reference our SimpleSigner.js
*  @param    {Object}            payload            payload object
*  @return   {Promise&lt;Object, Error>}               a promise which resolves with a signed JSON Web Token or rejects with an error
*/
function createJWT(_ref, payload) {
  var address = _ref.address,
      signer = _ref.signer;

  var signingInput = [ENCODED_HEADER, encodeSection(_extends({ iss: address, iat: Math.floor(Date.now() / 1000) }, payload))].join('.');

  return new Promise(function (resolve, reject) {
    if (!signer) return reject(new Error('No Signer functionality has been configured'));
    if (!address) return reject(new Error('No application identity address has been configured'));
    return signer(signingInput, function (error, signature) {
      if (error) return reject(error);
      resolve([signingInput, signature].join('.'));
    });
  });
}

/**
*  Verifies given JWT. Registry is used to resolve uPort address to public key for verification.
*  If the JWT is valid, the promise returns an object including the JWT, the payload of the JWT,
*  and the profile of the issuer of the JWT.
*
*  @example
*  const registry =  new UportLite()
*  verifyJWT({registry, address: '5A8bRWU3F7j3REx3vkJ...'}, 'eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NksifQ.eyJyZXF1Z....').then(obj => {
*      const payload = obj.payload
*      const profile = obj.profile
*      const jwt = obj.jwt
*      ...
*  })
*
*  @param    {Object}            [config]           an unsigned credential object
*  @param    {String}            config.address     address, typically the uPort address of the signer which becomes the issuer
*  @param    {UportLite}         config.registry    a uPort registry, reference our uport-lite library
*  @param    {String}            jwt                a JSON Web Token to verify
*  @param    {String}            callbackUrl        callback url in JWT
*  @return   {Promise&lt;Object, Error>}               a promise which resolves with a response object or rejects with an error
*/
function verifyJWT(_ref2, jwt) {
  var registry = _ref2.registry,
      address = _ref2.address;
  var callbackUrl = arguments.length > 2 &amp;&amp; arguments[2] !== undefined ? arguments[2] : null;

  return new Promise(function (resolve, reject) {
    var _decodeToken = (0, _jsontokens.decodeToken)(jwt),
        payload = _decodeToken.payload;

    registry(payload.iss).then(function (profile) {
      if (!profile) return reject(new Error('No profile found, unable to verify JWT'));
      var publicKey = profile.publicKey.match(/^0x/) ? profile.publicKey.slice(2) : profile.publicKey;
      var verifier = new _jsontokens.TokenVerifier('ES256K', publicKey);
      if (verifier.verify(jwt)) {
        if (payload.iat >= LEGACY_MS &amp;&amp; payload.iat > Date.now() + IAT_SKEW * 1000 || payload.iat &lt; LEGACY_MS &amp;&amp; payload.iat > Date.now() / 1000 + IAT_SKEW) {
          return reject(new Error('JWT not valid yet (issued in the future): iat: ' + payload.iat + ' > now: ' + Date.now() / 1000));
        }
        if (payload.exp &amp;&amp; payload.exp >= LEGACY_MS &amp;&amp; payload.exp &lt;= Date.now() || payload.iat &lt; LEGACY_MS &amp;&amp; payload.exp &lt;= Date.now() / 1000) {
          return reject(new Error('JWT has expired: exp: ' + payload.exp + ' &lt; now: ' + Date.now() / 1000));
        }
        if (payload.aud) {
          if (payload.aud.match(/^0x[0-9a-fA-F]+$/) || (0, _mnid.isMNID)(payload.aud)) {
            if (!address) {
              return reject(new Error('JWT audience is required but your app address has not been configured'));
            }

            var addressHex = (0, _mnid.isMNID)(address) ? (0, _mnid.decode)(address).address : address;
            var audHex = (0, _mnid.isMNID)(payload.aud) ? (0, _mnid.decode)(payload.aud).address : payload.aud;
            if (audHex !== addressHex) {
              return reject(new Error('JWT audience does not match your address: aud: ' + payload.aud + ' !== yours: ' + address));
            }
          } else {
            if (!callbackUrl) {
              return reject(new Error('JWT audience matching your callback url is required but one wasn\'t passed in'));
            }
            if (payload.aud !== callbackUrl) {
              return reject(new Error('JWT audience does not match the callback url: aud: ' + payload.aud + ' !== url: ' + callbackUrl));
            }
          }
        }
        resolve({ payload: payload, profile: profile, jwt: jwt });
      } else {
        return reject(new Error('Signature invalid for JWT'));
      }
    }).catch(reject);
  });
}

exports.default = { createJWT: createJWT, verifyJWT: verifyJWT };</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  
  
</body>
</html>
